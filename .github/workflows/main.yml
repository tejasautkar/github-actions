name: CI/CD to EC2 (Docker Compose)

on:
    push: 
        branches: ["main"]
        paths-ignore: 
            - ".gitignore"
    workflow_dispatch:
        inputs:
            target_branch:
                description: "Branch to deploy (e.g. main, staging, feature-x)"
                required: false
                default: "main"
            target_env:
                description: "Environment name (prod/staging/dev)"
                required: false
                default: "prod"


concurrency: 
    group: deploy-${{github.ref}}
    cancel-in-progress: true

jobs:
    deploy:
        name: Deploy to EC2
        runs-on: ubuntu-latest
        timeout-minutes: 20
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Add EC2 host to known_hosts
              run: |
                mkdir -p ~/.ssh
                ssh-keyscan -p "${{ secrets.EC2_PORT }}" -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts
            
            - name: Sync Repo to EC2
              uses: burnett01/rsync-deployments@7.0.1
              with:
                switches: >-
                    -azr --delete --omit-dir-times --no-perms --no-owner --no-group
                    --exclude=.git --exclude=.github --exclude=node_modules
                path: .
                remote_path: ${{ secrets.APP_DIR }}
                remote_host: ${{ secrets.EC2_HOST }}
                remote_port: ${{ secrets.EC2_PORT }}
                remote_user: ${{ secrets.EC2_USER }}
                remote_key: ${{ secrets.EC2_SSH_KEY }}

            - name: Write .env to EC2 (Github Secrets)
              uses: appleboy/ssh-action@v1.1.0
              with:
                 host: ${{ secrets.EC2_HOST }}
                 username: ${{ secrets.EC2_USER }}
                 key: ${{ secrets.EC2_SSH_KEY }}
                 port: ${{ secrets.EC2_PORT }}
                 script_stop: true
                 script: |
                    set -euo pipefail
                    mkdir -p "${{ secrets.APP_DIR }}"
                    cat > "${{ secrets.APP_DIR }}/.env" <<'EOF'
                    EOF
                    chmod 600 "${{ secrets.APP_DIR }}/.env"
            
            - name: Deploy via Docker Compose
              uses: appleboy/ssh-action@v1.1.0
              with:
                 host: ${{ secrets.EC2_HOST }}
                 username: ${{ secrets.EC2_USER }}
                 key: ${{ secrets.EC2_SSH_KEY }}
                 port: ${{ secrets.EC2_PORT }}
                 script_stop: true
                 script: |
                    set -euo pipefail
                    cd "${{ secrets.APP_DIR }}"
                    if ! docker compose version >/dev/null 2>&1; then
                        echo "Docker Compose plugin not found. Install it or symlink 'docker-compose' to 'docker compose'."
                        exit 1
                    fi

                    docker compose pull || true
                    docker compose down --remove-orphans
                    docker compose up -d --build
                    docker image prune -f --filter "until=168h" || true
            
            - name: Health check
              uses: appleboy/ssh-action@v1.1.0
              with:
                host: ${{ secrets.EC2_HOST }}
                username: ${{ secrets.EC2_USER }}
                key: ${{ secrets.EC2_SSH_KEY }}
                port: ${{ secrets.EC2_PORT }}
                script_stop: true
                script: |
                    set -euo pipefail
                    cd "${{ secrets.APP_DIR }}"
                    # Wait for API container to pass its healthcheck
                    echo "Waiting for api container to become healthy..."
                    for i in {1..30}; do
                    STATUS="$(docker inspect --format='{{json .State.Health.Status}}' "$(docker compose ps -q api)" 2>/dev/null || echo "null")"
                    if [ "$STATUS" = "\"healthy\"" ]; then
                        echo "API is healthy."
                        exit 0
                    fi
                    sleep 5
                    done
                    echo "API did not become healthy in time."
                    docker compose logs --no-color api || true
                    exit 1


              
                

        
